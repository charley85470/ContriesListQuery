<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Contries Query</title>
  </head>
  <body>
    <div>
      國家名稱<input type="text" id="Q_CountryName" />
      <button id="btSearch" type="button">查詢</button>
    </div>

    <div>
      <table id="resultTable">
        <thead>
          <th>國旗</th>
          <th>國家名稱</th>
          <th>2位國家代碼</th>
          <th>3位國家代碼</th>
          <th>母語名稱</th>
          <th>替代國家名稱</th>
          <th>國際電話區號</th>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      var countries = [];
      var displayCountries = [];
      window.onload = function () {
        GetCountryData();
        document.getElementById('btSearch').onclick = function () {
          GenerateTableRow(20, 1);
        };
      };

      // 取得國家資料
      function GetCountryData() {
        SendAjax({
          type: 'GET',
          url: 'https://restcountries.eu/rest/v2/all',
          onSuccess: function (result) {
            countries = JSON.parse(result);
            GenerateTableRow(20, 1);
          },
          onError() {},
        });
      }

      // 建立Ajax連線
      function SendAjax({
        type: type, // HTTP Type
        url: url, // Connect URL
        onSuccess: onSuccess, // Function when Call API Success
        onError: onError, // Function when Call API Error
      }) {
        var oReq = new XMLHttpRequest();

        // Event On Load Success
        oReq.addEventListener('load', function () {
          onSuccess(this.response);
        });

        // Event On Load Error
        oReq.addEventListener('error', function () {
          onError(this.response);
        });

        oReq.open(type, url); // Open Connection
        oReq.send(); // Send Request
      }

      // 綁定資料至Table內
      function GenerateTableRow(limit, page) {
        // 根據國家名稱篩選
        displayCountries = countries.filter((value, index) => {
          let countryName = document.getElementById('Q_CountryName').value;
          if (countryName) {
            return value.name.includes(countryName);
          } else {
            return value;
          }
        });

        let tb = document.querySelector('#resultTable tbody');
        tb.innerHTML = ''; // 清空內容
        let t = document.querySelector('#countryrow'); // Template Table row
        let td = t.content.querySelectorAll('td'); // table td items
        displayCountries.forEach((element) => {
          td[0].querySelector('img').src = element.flag;
          td[1].textContent = element.name;
          td[2].textContent = element.alpha2Code;
          td[3].textContent = element.alpha3Code;
          td[4].textContent = element.nativeName;
          td[5].textContent = element.altSpellings;
          td[6].textContent = element.callingCodes;

          tb.appendChild(document.importNode(t.content, true)); // DeepClone 並Appent到Tbody中
        });
      }
    </script>

    <template id="countryrow">
      <tr>
        <td>
          <img style="max-height: 2rem" src="" alt="" />
        </td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </template>
  </body>
</html>
